---
title: "Continuous Change Point Model by Marginalization"
author: "Michael Andreae"
date: "March 1, 2016"
output: pdf_document
---


```{r knitr, echo=FALSE}
suppressWarnings(library(knitr))
```

```{r globle_knitr_options, echo=FALSE}
rm(list=ls())
suppressWarnings(library(knitr))
# set options
opts_chunk$set(fig.width=6, fig.height=4, fig.path='Figs/',
               echo=FALSE, warning=FALSE, message=FALSE)
eval_everything=FALSE
```

```{r library}
library(gridExtra)
require(knitr)
library(tidyr)
library(rstan)
library(rstanarm)
library(shinystan)
require(ggplot2)
library(parallel)
library(nlme)
library(dplyr)
```

# Normal Model 1

Simple model of one set of repeated continous measures with one change point (s=40) and a pre e=1) and a post (l=10) slope, with some random error (sigma =20).

## Generate Data
```{r generate_data}

T <- as.integer(100) #length of data file
D <- vector(mode= "integer", length = T) # y

e <- 1 # slope before
l <- 10 # slope after
sigma <- 20 # standard deviation of error
c <- as.integer(rep(40, T)) # change point
t <- as.integer(1:T)
D <- ifelse((t<c), t*e,( c*e + (t-c)*l)) + rnorm(100, 0, sigma)

mydata <- data.frame(y=D, time=t, c=c)
g<- ggplot(mydata)
g+ geom_point(aes(t,y)) +theme_minimal() +geom_vline(xintercept = c)
```

## Compile
```{r compile, eval=FALSE}
continuous_data <- list(r_e = 1, r_l = 10, T = T, D = D, sigma=sigma)

MarginalChangePoint <- stan(file = 'Model_changePointContinuous.stan', 
                            data = continuous_data, 
                            iter = 10, chains = 4)
save(MarginalChangePoint, file="Fit/MarginalChangePoint.Rdata")
```

## Sampling
```{r sample, eval=FALSE}
load(file="Fit/MarginalChangePoint.Rdata")
continuous_data <- list(r_e = 1, r_l = 10, T = T, D = D, sigma=sigma)

fit1 <- stan(fit=MarginalChangePoint, iter= 1000, chains = 4, 
             data= continuous_data)
save(fit1, file="Fit/fit1.Rdata")
```

## results
```{r print_model1}
load(file="Fit/fit1.Rdata")
print(fit1, pars = c("l", "e", "s", "sigma"), probs= c(0.025, 0.5, 0.975))
```
The estimates correspond to the parameters used to generate the data.

# Normal Model 2

## Generate data
```{r generate_data_model2}

T <- as.integer(100) #length of data file
n <- 2 # number of unique patients
D <- matrix(vector(mode= "integer", length = T*2), ncol = n) # y

e <- 1 # slope before
l <- 10 # slope after
sigma <- 20 # standard deviation of error
c <- as.integer(rep(40, T)) # change point
t <- as.integer(1:T)

for (id in 1:n) {
  D[,id] <- ifelse((t<c), t*e,( c*e + (t-c)*l)) + rnorm(100, 0, sigma)
}

mydata <- data.frame(y1 = D[,1], y2 = D[,2], time=t, c=c)
g<- ggplot(mydata)
g +geom_point(aes(t,y1)) +geom_point(aes(t,y2, color="green")) +
  theme_minimal() +geom_vline(xintercept = c)
```

We generate two patient data sets with the same change point.

## Compile
```{r compile_M2, eval=FALSE}
continuous_data <- list(r_e = 1, r_l = 10, T = T, D = D, sigma=sigma, n=n)

MarginalChangePoint2 <- stan(file = 'Model_changePointContinuous2.stan', 
                              data= continuous_data,
                             iter = 10, chains = 4)
save(MarginalChangePoint2, file="Fit/MarginalChangePoint2.Rdata")
```

## Sampling
```{r sample_M2, eval=FALSE}
load(file="Fit/MarginalChangePoint2.Rdata")
continuous_data <- list(r_e = 1, r_l = 10, T = T, D = D, sigma=sigma, n=n)

fit2 <- stan(fit=MarginalChangePoint2, iter= 1000, chains = 4, 
             data= continuous_data)
save(fit2, file="Fit/fit2.Rdata")
```

## Results
```{r print_model2}
load(file="Fit/fit2.Rdata")
print(fit2, pars = c("l", "e", "s", "sigma"), probs= c(0.025, 0.5, 0.975))
```
The estimates of the second model M2 correspond to the parameters used to generate the data.

# Normal Model 3

## Generate data
```{r generate_data_model3}

T <- as.integer(100) #length of data file
n <- 2 # number of unique patients
D <- matrix(vector(mode= "integer", length = T*2), ncol = n) # y

a <- 50 # common intercept
e <- 1 # slope before change point 
l <- 10 # slope after change point
sigma <- 20 # standard deviation of error
c <- as.integer(rep(40, T)) # change point
t <- as.integer(1:T)

for (id in 1:n) {
  D[,id] <- ifelse((t<c), (a +t*e),(a +c*e + (t-c)*l)) + rnorm(100, 0, sigma)
}

mydata <- data.frame(y1 = D[,1], y2 = D[,2], time=t, c=c)
g<- ggplot(mydata)
g +geom_point(aes(t,y1)) +geom_point(aes(t,y2, color="green")) +
  theme_minimal() +geom_vline(xintercept = c)
```

We generate two patient data sets with the same change point.

## Compile
```{r compile_M3, eval=FALSE}
continuous_data <- list(r_e = 1, r_l = 10, T = T, D = D, sigma=sigma, n=n)

MarginalChangePoint3 <- stan(file = 'Model_changePointContinuous3.stan', 
                              data= continuous_data,
                             iter = 10, chains = 4)
save(MarginalChangePoint3, file="Fit/MarginalChangePoint3.Rdata")
```

## Sampling
```{r sample_M3, eval=FALSE}
load(file="Fit/MarginalChangePoint3.Rdata")
continuous_data <- list(r_e = 1, r_l = 10, T = T, D = D, sigma=sigma, n=n)

fit3 <- stan(fit=MarginalChangePoint3, iter= 1000, chains = 4, 
             data= continuous_data)
save(fit3, file="Fit/fit3.Rdata")
```
